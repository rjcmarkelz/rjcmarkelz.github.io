{
  "hash": "a81d2ac585fe17fea799ebbf6c24a333",
  "result": {
    "markdown": "---\ntitle: Miracle Mile Conifer Species\ndescription: --Mapping Species Occurance\nauthor: RJ Cody Markelz\ndate: '2021-06-17'\ncategories: [species distribution, modeling, GBIF, GIS, maps]\nimage: /images/Foxtail_Pine.png\n--- \n\n\n<p align=\"Left\">\n  <img src=\"/images/Foxtail_Pine.png\" alt=\"foxtail pine illustration\" height=\"300\"/>\n</p>\n\n# Introduction\nOverall, my research aims to understand how environmental factors, like wild fires, influence biodiversity. One of the most used databases for measuring biodiversity is the Global Biodiversity Information Facility [GBIF](https://www.gbif.org/). This is post is a brief introduction of how to use GBIF, using the example of mapping a few conifer species in California.\n\n\n### Load the libraries\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rgbif)\nlibrary(tidyverse)\nlibrary(data.table)\nlibrary(maps)\nlibrary(leaflet)\n```\n:::\n\n\n\n# Part 1 -Mapping one species\n\nUsing the R package function *occ_data()* request data from the GBIF database with the species name,  selecting the observations that have a coordinate, and limiting the query to 10000 observations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npinus_balfouriana <- occ_data(scientificName = \"Pinus balfouriana\", hasCoordinate = TRUE, limit = 1000)\n```\n:::\n\n\nInspect the data structure.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(pinus_balfouriana)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     Length Class  Mode\nmeta   4    -none- list\ndata 124    tbl_df list\n```\n:::\n:::\n\n\nThere are many different groups that contribute data to GBIF. Make sure you cite them accordingly so we can continue to have a great stream of species occurrence data. As a a few examples this species has curated research grade observations from iNaturalist and many from the Humboldt State University.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(gbif_citation(pinus_balfouriana), 2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: gbif_citation() for occ_search() and occ_data() is deprecated. \nUse rgbif::occ_download() or rgbif::derived_dataset() instead.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[[1]]\n<<rgbif citation>>\n   Citation: iNaturalist contributors, iNaturalist (2023). iNaturalist\n        Research-grade Observations. iNaturalist.org. Occurrence dataset\n        https://doi.org/10.15468/ab3s5x accessed via GBIF.org on 2023-03-29..\n        Accessed from R via rgbif (https://github.com/ropensci/rgbif) on\n        2023-03-29\n   Rights: http://creativecommons.org/licenses/by-nc/4.0/legalcode\n\n[[2]]\n<<rgbif citation>>\n   Citation: Rancho Santa Ana Botanic Garden (2023). RSA - California Botanic\n        Garden Herbarium. Occurrence dataset https://doi.org/10.15468/0yosx9\n        accessed via GBIF.org on 2023-03-29.. Accessed from R via rgbif\n        (https://github.com/ropensci/rgbif) on 2023-03-29\n   Rights: http://creativecommons.org/licenses/by-nc/4.0/legalcode\n```\n:::\n:::\n\n\nTake a look at what types of data are collected.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(names(pinus_balfouriana$data))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"key\"              \"scientificName\"   \"decimalLatitude\"  \"decimalLongitude\"\n[5] \"issues\"           \"datasetKey\"      \n```\n:::\n:::\n\n\nThe default GBIF query returns 126 columns of data. We do not have time to go through all of them for a single post so I will subset some important ones for some exploratory plotting purposes. Here I subset the Latitude and Longitude coordinates that we will use for mapping, if the species does occur (important for modeling in future posts), how uncertain the observation is in meters, and the references for the observation.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npinus_balfouriana_coords <- pinus_balfouriana$data[ , c(\"decimalLongitude\", \"decimalLatitude\",\n\"occurrenceStatus\", \"coordinateUncertaintyInMeters\", \"references\")]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# check out how the data is structured\nhead(pinus_balfouriana_coords)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 5\n  decimalLongitude decimalLatitude occurrenceStatus coordinateUncertai…¹ refer…²\n             <dbl>           <dbl> <chr>                           <dbl> <chr>  \n1            -118.            36.5 PRESENT                             4 https:…\n2            -118.            36.5 PRESENT                             4 https:…\n3            -118.            36.5 PRESENT                            NA https:…\n4            -123.            41.2 PRESENT                            11 https:…\n5            -118.            36.5 PRESENT                            65 https:…\n6            -118.            36.5 PRESENT                            47 https:…\n# … with abbreviated variable names ¹​coordinateUncertaintyInMeters, ²​references\n```\n:::\n\n```{.r .cell-code}\nsummary(pinus_balfouriana_coords)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n decimalLongitude decimalLatitude occurrenceStatus  \n Min.   :-123.3   Min.   :35.92   Length:1000       \n 1st Qu.:-118.4   1st Qu.:36.45   Class :character  \n Median :-118.4   Median :36.58   Mode  :character  \n Mean   :-118.8   Mean   :37.04                     \n 3rd Qu.:-118.3   3rd Qu.:36.62                     \n Max.   :-118.0   Max.   :42.01                     \n                                                    \n coordinateUncertaintyInMeters  references       \n Min.   :    2                 Length:1000       \n 1st Qu.:    5                 Class :character  \n Median :   19                 Mode  :character  \n Mean   : 2234                                   \n 3rd Qu.:  185                                   \n Max.   :28534                                   \n NA's   :777                                     \n```\n:::\n\n```{.r .cell-code}\n# pinus_balfouriana_coords$decimalLongitude # remove this row of bad data\npinus_balfouriana_coords <- slice(pinus_balfouriana_coords, -(278))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# two map functions... be clear! There are a few map functions with these different libraries loaded.\n#?map()\nmaps::map(database = \"state\", region = \"california\")\npoints(pinus_balfouriana_coords[ , c(\"decimalLongitude\", \"decimalLatitude\")], pch = \".\", col = \"red\", cex = 3)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\nSubset our search to only Northern California\n\n::: {.cell}\n\n```{.r .cell-code}\nmm_geometry <- paste('POLYGON((-124.4323 42.0021, -121.5045 42.0021, -121.5045 40.194, -124.4323 40.194, -124.4323 42.0021))')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npinus_balfouriana_NC <- occ_data(scientificName = \"Pinus balfouriana\", hasCoordinate = TRUE, limit = 1000,\n                     geometry = mm_geometry )\nhead(pinus_balfouriana_NC)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$meta\n$meta$offset\n[1] 0\n\n$meta$limit\n[1] 300\n\n$meta$endOfRecords\n[1] TRUE\n\n$meta$count\n[1] 151\n\n\n$data\n# A tibble: 151 × 125\n   key    scien…¹ decim…² decim…³ issues datas…⁴ publi…⁵ insta…⁶ publi…⁷ proto…⁸\n   <chr>  <chr>     <dbl>   <dbl> <chr>  <chr>   <chr>   <chr>   <chr>   <chr>  \n 1 39470… Pinus …    41.2   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 2 39474… Pinus …    41.2   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 3 39472… Pinus …    41.3   -122. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 4 39612… Pinus …    41.2   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 5 38729… Pinus …    41.2   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 6 38734… Pinus …    41.2   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 7 39609… Pinus …    40.9   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 8 40548… Pinus …    41.3   -122. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n 9 38736… Pinus …    41.3   -123. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n10 39471… Pinus …    41.3   -122. cdc,c… 50c950… 28eb1a… 997448… US      DWC_AR…\n# … with 141 more rows, 115 more variables: lastCrawled <chr>,\n#   lastParsed <chr>, crawlId <int>, hostingOrganizationKey <chr>,\n#   basisOfRecord <chr>, occurrenceStatus <chr>, taxonKey <int>,\n#   kingdomKey <int>, phylumKey <int>, classKey <int>, orderKey <int>,\n#   familyKey <int>, genusKey <int>, speciesKey <int>, acceptedTaxonKey <int>,\n#   acceptedScientificName <chr>, kingdom <chr>, phylum <chr>, order <chr>,\n#   family <chr>, genus <chr>, species <chr>, genericName <chr>, …\n```\n:::\n\n```{.r .cell-code}\npinus_balfouriana_NC_coords <- pinus_balfouriana_NC$data[ , c(\"decimalLongitude\", \"decimalLatitude\",\n \"individualCount\", \"occurrenceStatus\", \"coordinateUncertaintyInMeters\",\n  \"institutionCode\", \"references\")]\n```\n:::\n\n\nPlot the data in a few different ways to see if there is anything strange.\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(pinus_balfouriana_NC_coords$decimalLongitude, pinus_balfouriana_NC_coords$decimalLatitude) # examine the data\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\npinus_balfouriana_NC_coords %>% leaflet() %>% addTiles() %>%\naddMarkers(~decimalLongitude, ~decimalLatitude)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"leaflet html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-43dea062dca72dab88fc\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-43dea062dca72dab88fc\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org\\\">OpenStreetMap<\\/a> contributors, <a href=\\\"https://creativecommons.org/licenses/by-sa/2.0/\\\">CC-BY-SA<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[[41.21823,41.212389,41.316937,41.203787,41.247575,41.219855,40.943456,41.31987,41.302003,41.316639,41.586105,41.57892,41.575358,41.58585,41.316519,41.299637,41.31635,41.316783,41.318592,41.318628,41.576897,41.316517,41.318478,41.318353,40.944095,41.33424,41.190768,40.942346,41.317007,40.65773,41.215313,40.196262,41.316711,40.922437,41.30745,40.908228,40.933736,40.947325,40.910975,40.944594,40.953208,41.3298,41.316612,41.229703,41.222706,41.221478,41.221528,41.21985,41.212264,41.31575,41.317367,41.319594,41.351883,41.240508,41.574071,41.316621,40.926688,41.215205,41.212628,40.944371,41.204272,41.316998,41.204272,41.315939,40.930603,40.196389,41.31794,41.318484,41.301945,40.945768,41.303091,40.921978,41.317516,41.302778,41.302223,40.890842,41.091073,41.565592,41.318205,41.316868,41.000792,41.58765,40.958771,41.360536,41.32,41.316667,41.303298,41.316168,40.940952,41.74879,41.302283,41.06,41.341306,41.341306,41.341306,41.341306,41.341285,41.34131,41.34131,41.341306,41.319167,41.24197,41.026583,41.221278,41.317917,41.318417,41.351806,41.364806,41.359722,41.361417,41.377806,41.75,41.3083,40.94282,41.3065,40.95556,41.0185,41.3026,41.1666,41.576667,41.0492,41.305,40.9752,41.576667,41.3522,41.3031,41.32,41.32,41.316667,41.316667,41.356667,41.748333,41.05,41.05,40.954517,41.0529819,41.576667,40.205,41.57276,41.57003,41.5794843,41.57003,41.3162,41.5777,41.3195,41.319722,41.3197746,41.3693,41.3166,41.28,41.279999],[-122.789513,-122.789611,-122.485222,-122.814009,-122.793288,-122.788728,-122.903281,-122.479184,-122.955078,-122.487408,-123.0821,-123.082,-123.096555,-123.096322,-122.482092,-122.49952,-122.489503,-122.485847,-122.49067,-122.490678,-123.198005,-122.487778,-122.489875,-122.488678,-122.872944,-122.752088,-122.910701,-122.904394,-122.485204,-122.649697,-122.785662,-122.973641,-122.487091,-122.883972,-122.956587,-122.888719,-122.880667,-122.907409,-122.888569,-122.905872,-122.893944,-122.484445,-122.486575,-122.786461,-122.787711,-122.789056,-122.788978,-122.788339,-122.79026,-122.489281,-122.489616,-122.482687,-122.984507,-122.764137,-123.208499,-122.486099,-122.884712,-122.785995,-122.789438,-122.888217,-122.793547,-122.490301,-122.793547,-122.489123,-122.87459,-122.973333,-122.48008,-122.487147,-122.956108,-122.907149,-122.947325,-122.88378,-122.48941,-122.952225,-122.954422,-122.959784,-122.970327,-123.211345,-122.494852,-122.491801,-123.049686,-123.080931,-122.880363,-122.584725,-122.48,-122.483333,-122.954574,-122.489248,-122.887428,-123.13494,-122.957914,-122.92,-122.533667,-122.533667,-122.533667,-122.533667,-122.53366,-122.53367,-122.53367,-122.533667,-122.505278,-122.94758,-122.900194,-122.859972,-122.478306,-122.489111,-122.585056,-122.574528,-122.582806,-122.588056,-122.5745,-123.131667,-122.4885,-122.90701,-122.9546,-122.88089,-122.9716,-122.9528,-122.8055,-123.201667,-122.9159,-122.958333,-123.0688,-123.1,-122.5902,-122.9389,-122.483333,-122.483333,-122.483333,-122.483333,-122.566667,-123.133333,-122.91,-122.9,-122.893359,-122.9142418,-123.201667,-122.98139,-123.20858,-123.21158,-123.1989907,-123.21158,-122.4849,-123.2043,-122.4793,-122.479167,-122.4775296,-122.3498,-122.4867,-122.68,-122.679999],null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},null,null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[40.196262,41.75],\"lng\":[-123.21158,-122.3498]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n# Part 2- Map Multiple species\nFirst test the workflow with only a few species then do entire batch.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The test is commented out. Uncomment to test first.\n# mm_species <- c(\"Pinus balfouriana\", \"pinus albicaulis\", \"pinus monticola\") # uncomment to run small test version\n\n# Entire miracle mile species set\nmm_species <- c(\"Pinus balfouriana\", \"pinus albicaulis\", \"pinus monticola\", \"pinus jeffreyi\", \"pinus ponderosa\", \"pinus contorta\", \"pinus lambertiana\", \"abies concolor\", \"abies magnifica\", \"abies lasiocarpa\", \"picea engelmannii\", \"picea breweriana\", \"tsuga mertensiana\", \"pseudotsuga menziesii\", \"taxus brevifolia\", \"calocedrus decurrens\", \"juniperus communis\", \"juniperus occidentalis\")\n\nmm_all <- occ_data(scientificName = mm_species, hasCoordinate = TRUE, limit = 1000,\n                   geometry = mm_geometry)\nsummary(mm_all)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                       Length Class  Mode\nPinus balfouriana      2      -none- list\npinus albicaulis       2      -none- list\npinus monticola        2      -none- list\npinus jeffreyi         2      -none- list\npinus ponderosa        2      -none- list\npinus contorta         2      -none- list\npinus lambertiana      2      -none- list\nabies concolor         2      -none- list\nabies magnifica        2      -none- list\nabies lasiocarpa       2      -none- list\npicea engelmannii      2      -none- list\npicea breweriana       2      -none- list\ntsuga mertensiana      2      -none- list\npseudotsuga menziesii  2      -none- list\ntaxus brevifolia       2      -none- list\ncalocedrus decurrens   2      -none- list\njuniperus communis     2      -none- list\njuniperus occidentalis 2      -none- list\n```\n:::\n\n```{.r .cell-code}\nmm_species_coords_list <- vector(\"list\", length(mm_species))\nnames(mm_species_coords_list) <- mm_species\n\nfor (x in mm_species) {\n  coords <- mm_all[[x]]$data[ , c(\"decimalLongitude\", \"decimalLatitude\", \"occurrenceStatus\", \"coordinateUncertaintyInMeters\", \"institutionCode\", \"references\")]\n  mm_species_coords_list[[x]] <- data.frame(species = x, coords)\n}\n```\n:::\n\n\n<!--\n    For \"take a look at the output\" 'lapply(mm_species_coords_list, head)', reduce output. Maybe look at just the columns? colnames(DF)\n        Further, it would be nice to orient where what these data columns mean? Can you link to the documentation?\n -->\n\nUsing the rbindlist() function from the data.frame package to take all of the species observations from a list to a large data.frame. The columns are the species name, the latitude and longitude coordinates, whether or not there was an observation, if there is any uncertainty about how accurate the GPS coordinate was, what platform the observation was made on, and the specific reference for the observation. Make sure you cite the references so we can keep these rich data streams coming!\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntree_df <- rbindlist(mm_species_coords_list, fill = T)\ndim(tree_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 6643    7\n```\n:::\n\n```{.r .cell-code}\nhead(tree_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             species decimalLongitude decimalLatitude occurrenceStatus\n1: Pinus balfouriana        -122.7895        41.21823          PRESENT\n2: Pinus balfouriana        -122.7896        41.21239          PRESENT\n3: Pinus balfouriana        -122.4852        41.31694          PRESENT\n4: Pinus balfouriana        -122.8140        41.20379          PRESENT\n5: Pinus balfouriana        -122.7933        41.24757          PRESENT\n6: Pinus balfouriana        -122.7887        41.21986          PRESENT\n   coordinateUncertaintyInMeters institutionCode\n1:                            11     iNaturalist\n2:                            NA     iNaturalist\n3:                            15     iNaturalist\n4:                           258     iNaturalist\n5:                             4     iNaturalist\n6:                             8     iNaturalist\n                                           references\n1: https://www.inaturalist.org/observations/120244204\n2: https://www.inaturalist.org/observations/122764637\n3: https://www.inaturalist.org/observations/123619404\n4: https://www.inaturalist.org/observations/123747109\n5: https://www.inaturalist.org/observations/124097026\n6: https://www.inaturalist.org/observations/124337645\n```\n:::\n:::\n\n\nJust take a quick look at the raw observations plotted by latitude and longitude.\n\nPlot all of the species on the California map.\n\n::: {.cell}\n\n```{.r .cell-code}\nmaps::map(database = \"state\", region = \"california\")\npoints(tree_df[ , c(\"decimalLongitude\", \"decimalLatitude\")], pch = \".\", col = \"blue\", cex = 3)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nPlot all of the species using ggplot in case you want to visualize the species with something a bit fancier.\n\n::: {.cell}\n\n```{.r .cell-code}\nmm_species_plot1  <- ggplot(tree_df, aes(x=decimalLongitude, y = decimalLatitude, color = species)) +\n       geom_point() + labs(color = \"Species\", title = \"MM Zone\")\nmm_species_plot1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nThere is a lot more you can do for GBIF, but these notes should help for the purpose of mapping species occurrence. Now that the data is somewhat organized we can start doing some proper data cleaning and exploratory data analysis in a future post.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.6.1/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-1.12.4/jquery.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.1.2/leaflet.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}